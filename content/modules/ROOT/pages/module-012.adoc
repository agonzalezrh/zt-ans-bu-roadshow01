= Infrastructure Data Gathering with Ansible
:toc:
:toc-placement: preamble
:icons: font
:numbered:

== Introduction 📊

Sometimes you just need data about your systems, and Ansible is perfect for this task! While Ansible can automate almost everything, one of the best starting points is gathering infrastructure data.

You know you have servers, networks, and other infrastructure components, but auditing or gathering all the system data can be a massive exercise. Fortunately, you can use Ansible at scale to make this process efficient and automated.

== Lab Environment Setup

=== Credentials
Use these credentials to access your Ansible Automation Platform:

[cols="1,1", options="header"]
|===
| Username | Password
| admin    | ansible123!
|===

=== Server Information
Your DNS domain for this lab is: *[[ Instruqt-Var key="DOMAIN" hostname="control" ]]*

[cols="1,1", options="header"]
|===
| Server         | FQDN
| Windows Server | windows.[[ Instruqt-Var key="DOMAIN" hostname="control" ]]
| Node01         | node01.[[ Instruqt-Var key="DOMAIN" hostname="control" ]]
| Node02         | node02.[[ Instruqt-Var key="DOMAIN" hostname="control" ]]
| Node03         | node03.[[ Instruqt-Var key="DOMAIN" hostname="control" ]]
|===

== Lab Exercise 1: Discovering Server Information

=== Overview
Let's start by gathering detailed information about our servers using Ansible's built-in fact-gathering capabilities.

=== Step 1: Access Your Inventory

. Navigate to your lab `aap` tab and login with the credentials above
. Navigate to *Automation Execution* → *Infrastructure* → *Inventories*
+
NOTE: This is where we track all the systems we automate. You'll see several inventories already configured for you.

. Select the *Video Platform Inventory*
. Click on the *Hosts* tab

.Node Setup View
image::node01-setup.png[Initial node setup interface]

=== Step 2: Run Ad-Hoc Commands for System Facts

We'll use Ansible Automation Platform's ability to run ad-hoc commands to gather system facts and data.

. Select the host: `node01`
. Click on *Run command*
. From the module dropdown list, select the *Setup* module
. Click *Next*

.Setup Module Selection
image::setup.png[Setup module configuration]

=== Step 3: Configure Execution Environment

. Select the *Default execution environment*
. Click *Next*

TIP: In Ansible Automation Platform, we use Execution Environments to launch templates and playbooks. This provides consistent, containerized environments for our automation.

=== Step 4: Choose Credentials

. Select the *Application Nodes* credential
. Click *Next*
. Click *Finish*

=== Step 5: Review System Facts

Once the command executes, you'll see comprehensive system facts displayed.

.System Facts Output
image::setup-output.png[Complete system facts output]

This output contains all the information that Ansible can gather from the system, including:

* Hardware specifications
* Operating system details
* Network configuration
* Storage information
* Installed packages
* Environment variables
* And much more!

== Lab Exercise 2: Scaling Up - Infrastructure Reports

=== Overview
We need infrastructure awareness across our entire environment! With Ansible, creating dynamic reports based on facts and tasks is straightforward. Let's create comprehensive infrastructure reports.

=== Step 1: Generate Application Server Report

. Navigate to *Automation Execution* → *Templates*
. Execute the *Application Server Report* template
. When prompted with options, select *All*

=== Step 2: View the Generated Report

. Once the template completes, navigate to the *Report Server* tab
. Refresh the page to see the generated report

.Server Report Overview
image::srv-report.png[Comprehensive server report]

Notice that the report includes backup information as well!

.Backup Data Integration
image::backup-data.png[Backup data within the report]

=== Step 3: Create Custom Reports

You can re-run the report template and choose different options to create reports based on specific criteria:

* Filter by server type
* Focus on specific metrics
* Generate reports for particular time periods
* Create targeted reports for different teams

== Lab Exercise 3: Security Compliance Reporting

=== Overview
Reports are valuable for operations teams, but InfoSec teams love them even more! Let's run an OpenSCAP compliance report to satisfy security requirements.

Security has requested a compliance report for `Node02`. Let's generate this critical security documentation.

=== Step 1: Run OpenSCAP Compliance Scan

. Navigate to *Automation Execution* → *Templates*
. Execute the *OpenSCAP Report* template
. Wait for the job to complete

=== Step 2: Review Compliance Results

. Once completed, navigate to the *Compliance Report* tab
. View the generated compliance folder

.Compliance Report Folder
image::compliance_report_folder.png[Compliance report folder structure]

=== Step 3: Analyze Compliance Details

Click on the report to view detailed compliance results:

.Detailed Compliance Report
image::compliance_report.png[Detailed compliance scan results]

The report will show:

* ✅ **Passed** - Compliant controls
* ⚠️ **Failed** - Non-compliant controls requiring attention
* ℹ️ **Informational** - Additional security information
* 🔍 **Manual** - Items requiring manual verification

== Code Reference

=== OpenSCAP Automation Implementation

Here's the key Ansible code used for OpenSCAP compliance scanning:

[source,yaml]
----
tasks:
  - name: Check if the system is RHEL 8
    ansible.builtin.debug:
      msg: "This playbook is not compatible with {{ inventory_hostname }} (not RHEL 8)"
    when: ansible_distribution != "RedHat" or ansible_distribution_major_version != "8"
    failed_when: false

  - name: Run compliance tasks on RHEL 8 systems only
    when: ansible_distribution == "RedHat" and ansible_distribution_major_version == "8"
    block:
      - name: Get our facts straight
        ansible.builtin.set_fact:
          _profile: '{{ compliance_profile | replace("pci_dss", "pci-dss") }}'
          _report_dir: /tmp/oscap-reports

      - name: Ensure OpenSCAP tools are installed
        ansible.builtin.dnf:
          name: '{{ openscap_packages }}'
          state: present

      - name: Configure httpd
        when: use_httpd | bool
        block:
          - name: Install httpd
            ansible.builtin.dnf:
              name: httpd
              state: present
            notify: Restart httpd

          - name: Override report directory
            ansible.builtin.set_fact:
              _report_dir: /var/www/html/oscap-reports

          - name: Gather service facts
            ansible.builtin.service_facts:

          - name: Enable firewall http service
            ansible.posix.firewalld:
              service: http
              state: enabled
              immediate: true
              permanent: true
            when: "'firewalld.service' in ansible_facts.services"

          - name: Disable httpd welcome page
            ansible.builtin.file:
              path: /etc/httpd/conf.d/welcome.conf
              state: absent
            notify: Restart httpd

      - name: Create report on Report Server
        block:
          - name: Ensure report directory exists
            ansible.builtin.file:
              path: '{{ _report_dir }}/{{ _profile }}'
              state: directory
              owner: root
              group: root
              mode: 0755

          - name: Set report name
            ansible.builtin.set_fact:
              _report: '{{ _report_dir }}/{{ _profile }}/report-{{ inventory_hostname }}-{{ ansible_date_time.iso8601 }}.html'

          - name: Generate compliance report
            ansible.builtin.command: >-
              oscap xccdf eval --profile {{ _profile }} --report {{ _report }}
              /usr/share/xml/scap/ssg/content/ssg-rhel{{ ansible_distribution_major_version }}-ds.xml
            args:
              creates: '{{ _report }}'
            register: _oscap
            failed_when: _oscap.rc not in [0, 2]

          - name: Set report permissions
            ansible.builtin.file:
              path: '{{ _report }}'
              owner: root
              group: root
              mode: 0644
----

== Key Benefits Achieved

=== Infrastructure Visibility
* 📈 **Comprehensive Data Collection** - Gather detailed facts from all systems
* 🔍 **Automated Discovery** - No manual system auditing required
* 📊 **Dynamic Reporting** - Generate reports based on real-time data

=== Security Compliance
* 🛡️ **Automated Compliance Scanning** - Regular security assessments
* 📋 **Standardized Reports** - Consistent compliance documentation
* ⚡ **Rapid Assessment** - Quick identification of security gaps

=== Operational Efficiency
* 🚀 **Scalable Operations** - Manage hundreds of systems simultaneously
* 📅 **Scheduled Automation** - Regular, unattended data collection
* 🎯 **Targeted Reporting** - Custom reports for different stakeholders

== Next Steps

Congratulations! You've successfully:

* ✅ Gathered comprehensive system facts using Ansible
* ✅ Generated infrastructure reports at scale
* ✅ Implemented security compliance scanning
* ✅ Created automated reporting workflows

=== Recommended Follow-up Actions

. **Schedule Regular Reports** - Set up automated report generation
. **Expand Compliance Scanning** - Add more security profiles
. **Create Custom Dashboards** - Build visualization tools
. **Implement Alerting** - Set up notifications for compliance failures

== Troubleshooting

=== Common Issues and Solutions

**Problem**: Setup module fails to execute
**Solution**: Verify host connectivity and credential permissions

**Problem**: Compliance scan returns errors
**Solution**: Ensure OpenSCAP packages are installed and up-to-date

**Problem**: Reports don't generate
**Solution**: Check execution environment and template configuration

**Problem**: Permission denied errors
**Solution**: Verify service account has appropriate privileges

For additional assistance, consult the Ansible Automation Platform documentation or contact your system administrator.
